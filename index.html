<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MMD Model Viewer (Smooth Morph + White BG)</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js",
        "three/examples/jsm/loaders/MMDLoader": "https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/loaders/MMDLoader.js"
      }
    }
  </script>
</head>
<body>
  <script type="module">
    import * as THREE from "three";
    import { MMDLoader } from "three/examples/jsm/loaders/MMDLoader";

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.set(0, 9.5, 6);
    camera.lookAt(0, 10, 0);

    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    const spotLight = new THREE.SpotLight(0xffffff, 1);
    spotLight.position.set(15, 40, 35);
    scene.add(spotLight);

    let model;
    let isSmiling = false; // 笑顔中かどうかのフラグ
    let smileMorphIndex;   // 笑顔モーフのインデックスを保持

    const loader = new MMDLoader();
    loader.load(
      './Lumine/Lumine.pmx',
      (mesh) => {
        model = mesh;
        scene.add(mesh);
        mesh.position.set(0, -5.5, 0);

        console.log("モーフターゲット情報:", model.morphTargetDictionary);
        smileMorphIndex = model.morphTargetDictionary["笑い"]; 

        // クリックしてフラグだけ反転
        document.addEventListener('click', () => {
          if (model && smileMorphIndex !== undefined) {
            isSmiling = !isSmiling;
            console.log("表情切替: isSmiling = ", isSmiling);
          }
        });

        // アニメーションループ
        function animate() {
          requestAnimationFrame(animate);

          if (model && smileMorphIndex !== undefined) {
            const currentValue = model.morphTargetInfluences[smileMorphIndex];
            const targetValue = isSmiling ? 1.0 : 0.0;
            const speed = 0.05; 

            // 滑らかにモーフ値変化
            model.morphTargetInfluences[smileMorphIndex]
              = THREE.MathUtils.lerp(currentValue, targetValue, speed);
          }

          renderer.render(scene, camera);
        }
        animate();
      },
      undefined,
      (error) => console.error(error)
    );
  </script>
</body>
</html>
