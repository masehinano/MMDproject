<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MMD Model Viewer</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js",
        "three/examples/jsm/loaders/MMDLoader": "https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/loaders/MMDLoader.js"
      }
    }
  </script>
</head>
<body>
  <script type="module">
    import * as THREE from "three";
    import { MMDLoader } from "three/examples/jsm/loaders/MMDLoader";

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.set(0, 9.5, 6); 
    camera.lookAt(0, 10, 0);

    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    const spotLight = new THREE.SpotLight(0xffffff, 1);
    spotLight.position.set(15, 40, 35);
    scene.add(spotLight);

    let model; // モデルを格納する変数
    let isSmiling = false; // 笑顔状態かどうかを記憶するフラグ

    const loader = new MMDLoader();
    loader.load(
      './mmd/Lumine/Lumine.pmx',
      (mesh) => {
        model = mesh; 
        scene.add(mesh);
        mesh.position.set(0, -5.5, 0);

        console.log("モーフターゲット情報:", model.morphTargetDictionary);

        const smileMorphIndex = model.morphTargetDictionary["笑い"]; // 笑顔モーフのインデックスを取得

        // クリック
        document.addEventListener('click', () => {
          if (model && smileMorphIndex !== undefined) {
            if (isSmiling) {
              // 元の表情に戻す（モーフ影響度を0にする）
              model.morphTargetInfluences[smileMorphIndex] = 0.0;
              console.log("元の表情に戻りました");
            } else {
              // 笑顔モーフを適用
              model.morphTargetInfluences[smileMorphIndex] = 1.0;
              console.log("笑顔モーフ適用");
            }
            isSmiling = !isSmiling; // 状態を反転
          }
        });

        // アニメーションループ
        function animate() {
          requestAnimationFrame(animate);
          renderer.render(scene, camera);
        }
        animate();
      },
      undefined,
      (error) => console.error(error)
    );
  </script>
</body>
</html>
